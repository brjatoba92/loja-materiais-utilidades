require('dotenv').config();
const bcrypt = require('bcryptjs');
const pool = require('../config/database');
const readline = require('readline');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// Fun√ß√£o para fazer perguntas ao usu√°rio
function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

// Fun√ß√£o para criar administrador
async function createAdmin(usuario, senha, nome) {
  try {
    console.log('üîß Criando administrador...');
    console.log('Usu√°rio:', usuario);
    console.log('Nome:', nome);
    console.log('');

    const senhaHash = await bcrypt.hash(senha, 10);

    const query = `
      INSERT INTO administradores (usuario, senha_hash, nome)
      VALUES ($1, $2, $3)
      ON CONFLICT (usuario) DO UPDATE SET
        senha_hash = EXCLUDED.senha_hash,
        nome = EXCLUDED.nome,
        updated_at = NOW()
      RETURNING *
    `;

    const result = await pool.query(query, [usuario, senhaHash, nome]);

    if (result.rows.length > 0) {
      console.log('‚úÖ Administrador criado/atualizado com sucesso!');
      console.log('üìã Dados do administrador:');
      console.log('   ID:', result.rows[0].id);
      console.log('   Usu√°rio:', result.rows[0].usuario);
      console.log('   Nome:', result.rows[0].nome);
      console.log('   Criado em:', result.rows[0].created_at);
      console.log('');
      console.log('üîë Credenciais para login:');
      console.log('   Usu√°rio:', usuario);
      console.log('   Senha:', senha);
      console.log('');
      console.log('‚ö†Ô∏è  IMPORTANTE: Altere a senha ap√≥s o primeiro login!');
    }

    return true;
  } catch (error) {
    console.error('‚ùå Erro ao criar administrador:', error.message);
    return false;
  }
}

// Fun√ß√£o para listar administradores
async function listAdmins() {
  try {
    console.log('üìã Listando administradores...\n');
    
    const query = 'SELECT id, usuario, nome, ultimo_acesso, created_at, updated_at FROM administradores ORDER BY id';
    const result = await pool.query(query);

    if (result.rows.length === 0) {
      console.log('‚ùå Nenhum administrador encontrado.');
      return;
    }

    console.log('‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê');
    console.log('‚îÇ ID  ‚îÇ   Usu√°rio    ‚îÇ         Nome         ‚îÇ    √öltimo Acesso     ‚îÇ     Criado em        ‚îÇ');
    console.log('‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§');

    result.rows.forEach(admin => {
      const id = admin.id.toString().padEnd(4);
      const usuario = admin.usuario.padEnd(13);
      const nome = (admin.nome || '').padEnd(20);
      const ultimoAcesso = admin.ultimo_acesso ? 
        new Date(admin.ultimo_acesso).toLocaleString('pt-BR').padEnd(20) : 
        'Nunca'.padEnd(20);
      const criadoEm = new Date(admin.created_at).toLocaleString('pt-BR').padEnd(20);
      
      console.log(`‚îÇ ${id} ‚îÇ ${usuario} ‚îÇ ${nome} ‚îÇ ${ultimoAcesso} ‚îÇ ${criadoEm} ‚îÇ`);
    });

    console.log('‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò');
    console.log(`\nüìä Total de administradores: ${result.rows.length}`);

  } catch (error) {
    console.error('‚ùå Erro ao listar administradores:', error.message);
  }
}

// Fun√ß√£o para atualizar administrador
async function updateAdmin(id, usuario, senha, nome) {
  try {
    console.log('üîÑ Atualizando administrador...');
    
    let query, params;
    
    if (senha) {
      const senhaHash = await bcrypt.hash(senha, 10);
      query = `
        UPDATE administradores 
        SET usuario = $1, senha_hash = $2, nome = $3, updated_at = NOW()
        WHERE id = $4
        RETURNING *
      `;
      params = [usuario, senhaHash, nome, id];
    } else {
      query = `
        UPDATE administradores 
        SET usuario = $1, nome = $2, updated_at = NOW()
        WHERE id = $3
        RETURNING *
      `;
      params = [usuario, nome, id];
    }

    const result = await pool.query(query, params);

    if (result.rows.length > 0) {
      console.log('‚úÖ Administrador atualizado com sucesso!');
      console.log('üìã Dados atualizados:');
      console.log('   ID:', result.rows[0].id);
      console.log('   Usu√°rio:', result.rows[0].usuario);
      console.log('   Nome:', result.rows[0].nome);
      console.log('   Atualizado em:', result.rows[0].updated_at);
    } else {
      console.log('‚ùå Administrador n√£o encontrado.');
    }

    return true;
  } catch (error) {
    console.error('‚ùå Erro ao atualizar administrador:', error.message);
    return false;
  }
}

// Fun√ß√£o para deletar administrador
async function deleteAdmin(id) {
  try {
    console.log('üóëÔ∏è  Deletando administrador...');
    
    const query = 'DELETE FROM administradores WHERE id = $1 RETURNING *';
    const result = await pool.query(query, [id]);

    if (result.rows.length > 0) {
      console.log('‚úÖ Administrador deletado com sucesso!');
      console.log('üìã Administrador removido:');
      console.log('   ID:', result.rows[0].id);
      console.log('   Usu√°rio:', result.rows[0].usuario);
      console.log('   Nome:', result.rows[0].nome);
    } else {
      console.log('‚ùå Administrador n√£o encontrado.');
    }

    return true;
  } catch (error) {
    console.error('‚ùå Erro ao deletar administrador:', error.message);
    return false;
  }
}

// Fun√ß√£o para buscar administrador por ID
async function findAdminById(id) {
  try {
    const query = 'SELECT id, usuario, nome, ultimo_acesso, created_at, updated_at FROM administradores WHERE id = $1';
    const result = await pool.query(query, [id]);
    return result.rows[0];
  } catch (error) {
    console.error('‚ùå Erro ao buscar administrador:', error.message);
    return null;
  }
}

// Menu principal
async function showMenu() {
  console.log('\n' + '='.repeat(60));
  console.log('üîß GERENCIADOR DE ADMINISTRADORES');
  console.log('='.repeat(60));
  console.log('1. üìù Criar novo administrador');
  console.log('2. üìã Listar todos os administradores');
  console.log('3. ‚úèÔ∏è  Atualizar administrador');
  console.log('4. üóëÔ∏è  Deletar administrador');
  console.log('5. üîç Buscar administrador por ID');
  console.log('6. üö™ Sair');
  console.log('='.repeat(60));
}

// Fun√ß√£o principal
async function main() {
  try {
    console.log('üîß Iniciando gerenciador de administradores...');
    
    while (true) {
      await showMenu();
      const choice = await question('\nEscolha uma op√ß√£o (1-6): ');

      switch (choice) {
        case '1':
          console.log('\nüìù CRIAR NOVO ADMINISTRADOR');
          console.log('-'.repeat(30));
          const usuario = await question('Usu√°rio: ');
          const senha = await question('Senha: ');
          const nome = await question('Nome completo: ');
          
          if (usuario && senha && nome) {
            await createAdmin(usuario, senha, nome);
          } else {
            console.log('‚ùå Todos os campos s√£o obrigat√≥rios!');
          }
          break;

        case '2':
          console.log('\nüìã LISTAR ADMINISTRADORES');
          console.log('-'.repeat(30));
          await listAdmins();
          break;

        case '3':
          console.log('\n‚úèÔ∏è  ATUALIZAR ADMINISTRADOR');
          console.log('-'.repeat(30));
          const updateId = await question('ID do administrador: ');
          const admin = await findAdminById(updateId);
          
          if (admin) {
            console.log(`\nAdministrador encontrado: ${admin.nome} (${admin.usuario})`);
            const newUsuario = await question(`Novo usu√°rio (${admin.usuario}): `) || admin.usuario;
            const newSenha = await question('Nova senha (deixe em branco para manter): ');
            const newNome = await question(`Novo nome (${admin.nome}): `) || admin.nome;
            
            await updateAdmin(updateId, newUsuario, newSenha, newNome);
          } else {
            console.log('‚ùå Administrador n√£o encontrado!');
          }
          break;

        case '4':
          console.log('\nüóëÔ∏è  DELETAR ADMINISTRADOR');
          console.log('-'.repeat(30));
          const deleteId = await question('ID do administrador: ');
          const adminToDelete = await findAdminById(deleteId);
          
          if (adminToDelete) {
            console.log(`\nAdministrador encontrado: ${adminToDelete.nome} (${adminToDelete.usuario})`);
            const confirm = await question('Tem certeza que deseja deletar? (s/N): ');
            
            if (confirm.toLowerCase() === 's' || confirm.toLowerCase() === 'sim') {
              await deleteAdmin(deleteId);
            } else {
              console.log('‚ùå Opera√ß√£o cancelada.');
            }
          } else {
            console.log('‚ùå Administrador n√£o encontrado!');
          }
          break;

        case '5':
          console.log('\nüîç BUSCAR ADMINISTRADOR');
          console.log('-'.repeat(30));
          const searchId = await question('ID do administrador: ');
          const searchAdmin = await findAdminById(searchId);
          
          if (searchAdmin) {
            console.log('\nüìã Dados do administrador:');
            console.log('   ID:', searchAdmin.id);
            console.log('   Usu√°rio:', searchAdmin.usuario);
            console.log('   Nome:', searchAdmin.nome);
            console.log('   √öltimo acesso:', searchAdmin.ultimo_acesso || 'Nunca');
            console.log('   Criado em:', new Date(searchAdmin.created_at).toLocaleString('pt-BR'));
            console.log('   Atualizado em:', new Date(searchAdmin.updated_at).toLocaleString('pt-BR'));
          } else {
            console.log('‚ùå Administrador n√£o encontrado!');
          }
          break;

        case '6':
          console.log('\nüëã Saindo do gerenciador de administradores...');
          rl.close();
          process.exit(0);
          break;

        default:
          console.log('‚ùå Op√ß√£o inv√°lida! Escolha uma op√ß√£o de 1 a 6.');
      }

      if (choice !== '6') {
        await question('\nPressione ENTER para continuar...');
      }
    }
  } catch (error) {
    console.error('‚ùå Erro no gerenciador:', error.message);
    rl.close();
    process.exit(1);
  }
}

// Verificar argumentos da linha de comando
const args = process.argv.slice(2);

if (args.length >= 3) {
  // node adminManager.js usuario senha nome
  createAdmin(args[0], args[1], args[2]).then(() => {
    rl.close();
    process.exit(0);
  });
} else {
  // Executar menu interativo
  main();
} 